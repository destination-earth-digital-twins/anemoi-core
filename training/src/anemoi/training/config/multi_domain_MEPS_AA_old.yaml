defaults:
- data: zarr
- dataloader: multi_domain
- diagnostics: evaluation
- hardware: slurm
- graph: multi_domain_stretch
- model: dynamic_graphtransformer
- training: default
- _self_


### This file is for local experimentation.
##  When you commit your changes, assign the new features and keywords
##  to the correct defaults.
# For example to change from default GPU count:
# hardware:
#   num_gpus_per_node: 1
graph:
  overwrite: False
  nodes:
    hidden:
      node_builder:
        _target_: anemoi.graphs.nodes.StretchedTriNodes
        lam_resolution: 5
        global_resolution: 3
        reference_node_name: ${graph.data}
        mask_attr_name: cutout
        margin_radius_km: 11

diagnostics:
  log:
    mlflow:
      enabled: True
      offline: True
      authentication: True
      experiment_name: 'multi-domain-experiments'
      project_name: 'Anemoi'
      log_model: False
      tracking_uri: 'https://mlflow.ecmwf.int'
    wandb:
      enabled: False
  print_memory_summary: True
  show_entire_globe: False
hardware:
  paths:
    output: /pfs/lustrep4/scratch/project_465000527/buurmans/DE_330_WP14/Anemoi/multi-domain-training/OUTPUT_OLD_3_5
  files:
    warm_start: /pfs/lustrep4/scratch/project_465000527/anemoi/experiments/n320_arome_meps_pretrain/anemoi-by_epoch-epoch_038-step_019503.ckpt
   # warm_start: /pfs/lustrep4/scratch/project_465000527/buurmans/DE_330_WP14/Anemoi/multi-domain-training/output/checkpoint/da64f6127b654ba69b120c8e0aec8304/anemoi-by_time-epoch_032-step_042891.ckpt
  num_gpus_per_node: 8
  num_nodes: 8
  num_gpus_per_model: 8
model:
  num_channels: 1024
training:
  run_id: 
  transfer_learning: True
  load_weights_only: True
  lr:
    rate: 0.04e-4 #local_lr
  validation_metrics:
    # loss class to initialise
    - _target_: anemoi.training.losses.mse.WeightedMSELoss
      #Â Scalars to include in loss calculation
      # Cannot scale over the variable dimension due to possible remappings.
      # Available scalars include:  
      # - 'loss_weights_mask': Giving imputed NaNs a zero weight in the loss function
      # Use the `scale_validation_metrics` section to variable scale.
      scalars: []
      # other kwargs
      ignore_nans: True
    - _target_: anemoi.training.losses.multidomain_mse.MultiDomainMSELoss
      loss_name: "AA"
      ignore_nans: True
    - _target_: anemoi.training.losses.multidomain_mse.MultiDomainMSELoss
      loss_name: "MEPS"
      ignore_nans: True

dataloader:
  num_workers:
    training: 8
    validation: 8
    test: 1
    predict: 1
  limit_batches:
    training: 4000
    validation: 700
  global:         
    concat:
      - dataset: ${hardware.paths.data}/aifs-ea-an-oper-0001-mars-o96-1979-2022-6h-v6.zarr
        start: null
        end: 2021-12-31
      - dataset: ${hardware.paths.data}/aifs-od-an-oper-0001-mars-o96-2016-2023-6h-v6.zarr
        start: 2022-01-01
        end: 2023-12-31
  #new
  training_periods:
    MEPS:
      start: 2020-02-05 
      end: 2023-05-31
    AA:
      start: 2017-01-01
      end: 2022-05-31

  #new
  validation_periods:
    MEPS:
      start: 2023-06-01
      end: 2024-05-31
    AA:
      start: "2022-06-01"
      end: "2022-12-31"

  # new
  regional_datasets:
    MEPS: 
      dataset: /pfs/lustrep4/scratch/project_465000527/anemoi/datasets/MEPS/aifs-meps-2.5km-2020-2024-6h-v6.zarr
    AA: 
      dataset: /pfs/lustrep4/scratch/project_465000527/anemoi/datasets/AROME-ARCTIC/arome_arctic-2_5km-2017-2024.zarr

  select:
    - 2t
    - 2d
    - 10u
    - 10v
    - msl
    - sp
    - lsm
    - skt
    - z
    - tp
    - u_100
    - u_150
    - u_200
    - u_300
    - u_400
    - u_500
    - u_700
    - u_850
    - u_925
    - u_1000
    - v_100
    - v_150
    - v_200
    - v_300
    - v_400
    - v_500
    - v_700
    - v_850
    - v_925
    - v_1000
    - t_100
    - t_150
    - t_200
    - t_300
    - t_400
    - t_500
    - t_700
    - t_850
    - t_925
    - t_1000
    - q_100
    - q_150
    - q_200
    - q_300
    - q_400
    - q_500
    - q_700
    - q_850
    - q_925
    - q_1000
    - z_100
    - z_150
    - z_200
    - z_300
    - z_400
    - z_500
    - z_700
    - z_850
    - z_925
    - z_1000
    - cos_latitude
    - cos_longitude
    - sin_latitude
    - sin_longitude
    - cos_julian_day
    - cos_local_time
    - sin_julian_day
    - sin_local_time
    - insolation

    